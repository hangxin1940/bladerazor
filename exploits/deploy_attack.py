from textwrap import dedent

from crewai import Agent, Task, Crew
from crewai_tools import BaseTool

from exploits.web.curl_tool import CurlTool
from persistence.database import DB
from rag.rag import RAG
from config import logger


class DeployAttack:
    """
    部署攻击
    """

    def __init__(self, db: DB, rag: RAG, llm=None, verbose: bool = False):
        self.llm = llm
        self.db = db
        self.rag = rag
        self.verbose = verbose

    def _getPenTestTools(self) -> []:
        tools = []
        tools.append(CurlTool())
        return tools

    def task_establishing_foothold_attack(self, agent: Agent, asset: str, plan: str) -> Task:
        logger.info("初始化任务 实施打点")
        return Task(
            agent=agent,
            description=dedent(
                f"""                  
                你的任务是根据攻击计划，针对目标灵活运用策略并合理使用各种工具，成功利用漏洞，最终取得敏感信息或得到控制权。
                这一过程将涉及多种渗透工具和策略，以确保在目标网络或系统中安全且隐蔽地实施打点行动。            
                在整个任务过程中，务必保持隐蔽性和安全性，避免任何可能引发目标系统警觉的行为。
                
                你应该根据你所使用的工具的特性，分析其输出，以此来确定你的攻击是否成功。
                
                注意，首先判断攻击计划是否合理，然后根据计划执行攻击。
                
                目标:
                {asset}

                攻击计划:
                {plan}
                """),
            expected_output=dedent(
                """
                对于敏感信息泄漏类型的任务，
                最终答案应包括你发现的所有敏感信息的列表。
                只输出已发现的敏感信息。
                不要将原始输入作为输出。
                确保信息分类明确，例如：密码、密钥、版本信息、路径信息、数据库配置、系统配置、用户名等。
                
                对于控制权获取类型的任务，
                最终答案应包括你成功获取的控制权的列表。
                """),
        )

    def agent_establishing_foothold_attacker(self, llm=None, tools: [BaseTool] = []) -> Agent:
        logger.info("初始化代理 打点实施专家")
        agent = Agent(
            role='打点实施专家',
            goal='通过高效利用已识别的安全漏洞，在目标网络或系统中建立并维持立足点，确保后续的渗透测试和长期的网络侦察得以成功进行。',
            backstory=dedent(
                """
                你是一名经验丰富的打点专家，隶属于攻击团队。
                你的核心任务是通过巧妙的技术手段和深厚的安全知识，在目标系统中建立持久的访问权限。
                你精通多种渗透工具和技术，能够在复杂的网络环境中识别并利用微妙的安全漏洞。
                你的技能不仅限于技术渗透，还包括对攻击策略的深入理解，能够识别并利用复杂系统的微妙弱点。
                你的主要职责是通过技术手段建立初始的访问权，并扩展这些访问权限以形成持久的立足点。
                你的工作对于后续的渗透阶段至关重要，因为它们提供了进行深入分析和数据窃取所需的访问基础。
        
                你的专业知识和战术洞察力使你成为攻击团队中不可或缺的一员，你对网络安全的热情和对挑战的渴望推动你不断寻找更有效的渗透方法。
                """),
            tools=tools,
            verbose=self.verbose,
            allow_delegation=True,
            max_rpm=300,
            # max_iter=1,
            llm=llm,
            cache=False,
        )

        if llm is not None:
            agent.llm = llm
        return agent

    def establishingFootholdAttackCrew(self, asset: str, plan: str):
        agents = []
        tasks = []
        tools = self._getPenTestTools()

        agefa = self.agent_establishing_foothold_attacker(self.llm, tools=tools)
        agents.append(agefa)
        tasks.append(self.task_establishing_foothold_attack(agefa, asset, plan))

        logger.info("初始化智能体 打点实施")
        return Crew(
            agents=agents,
            tasks=tasks,
            verbose=self.verbose,
            share_crew=False,
            cache=False
        )
