import json


class FingerPrint:
    def __init__(self,
                 name: str,
                 headers=None,
                 body=None,
                 favicons=None
                 ):
        self.name = name
        self.headers = headers
        self.body = body
        self.favicons = favicons

    def _match_favicon(self, favicon: str = None) -> bool:
        if favicon is None:
            return False
        if self.favicons is None:
            return False
        for sv in self.favicons:
            if sv == favicon:
                return True
        return False

    def _match_body(self, body: str = None) -> bool:
        if body is None:
            return False
        if self.body is None:
            return False

        mcount = 0
        for sv in self.body:
            if sv in body:
                mcount += 1

        if mcount >= len(self.body):
            return True
        return False

    def _match_headers(self, headers: dict = None) -> bool:
        if headers is None:
            return False

        if self.headers is None:
            return False

        if type(self.headers) is dict:
            mcount = 0
            for key, value in self.headers.items():
                if key in headers:
                    if value in headers[key]:
                        mcount += 1
            if mcount >= len(self.headers):
                return True

        elif type(self.headers) is list:
            vals = headers.values()
            mcount = 0
            for sv in self.headers:
                for tv in vals:
                    if sv in tv:
                        mcount += 1
            if mcount >= len(self.headers):
                return True

        return False

    def match(self, headers: dict = None, body: str = None, favicon_int: str = None, favicon_md5: str = None) -> bool:
        if self._match_headers(headers):
            return True

        if self._match_body(body):
            return True

        if self._match_favicon(favicon_int):
            return True

        if self._match_favicon(favicon_md5):
            return True

        return False

    def __repr__(self):
        return f"FingerPrint(name={self.name!r}, headers={self.headers!r}, body={self.body!r}, favicons={self.favicons!r})"


class WebFingers:
    fingers: [FingerPrint] = []

    def __init__(self):
        self.fingers = self._parse_arl_fingers() + self._parse_web_fingerprint()

    def match(self, headers: dict = None, body: str = None, favicon_int: str = None, favicon_md5: str = None) -> \
            [FingerPrint]:
        matched = []
        for finger in self.fingers:
            if finger.match(headers, body, favicon_int, favicon_md5):
                matched.append(finger)
        return matched

    def _parse_web_fingerprint(self) -> [FingerPrint]:
        fingers = []
        # https://github.com/0x727/FingerprintHub/
        with open('assets/web_fingerprint_v3.json') as f:
            data = json.load(f)
            for item in data:
                if item['request_data'] != "":
                    continue
                elif item['request_method'] != "get":
                    continue
                elif item['path'] != "/":
                    continue

                finger = FingerPrint(name=item['name'])
                if len(item['headers']) > 0:
                    finger.headers = item['headers']
                if len(item['keyword']) > 0:
                    finger.body = item['keyword']
                if len(item['favicon_hash']) > 0:
                    finger.favicons = item['favicon_hash']

                fingers.append(finger)

        return fingers

    def _parse_arl_fingers(self) -> [FingerPrint]:
        # https://github.com/loecho-sec/ARL-Finger-ADD
        datas = []
        with open('assets/arl_finger.json') as f:
            data = json.load(f)
            datas += data['fingerprint']
        # https://github.com/EASY233/Finger/
        with open('assets/finger.json') as f:
            data = json.load(f)
            datas += data['fingerprint']

        fingers = []
        for item in datas:
            finger = FingerPrint(name=item['cms'])
            if item['method'] == "keyword":
                if item['location'] == "header":
                    finger.headers = item['keyword']
                else:
                    finger.body = item['keyword']
            elif item['method'] == "faviconhash":
                finger.favicons = item['keyword']
            else:
                continue
            fingers.append(finger)

        return fingers
